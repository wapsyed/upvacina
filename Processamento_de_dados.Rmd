---
title: "UPVacina"
output: html_notebook
---

# Bibliotecas
```{r}

# install.packages("writexl")
# devtools::install_github('Mikata-Project/ggthemr')

library(tidyverse)
library(here)
library(writexl)
library(readxl)
library(janitor)
library(stringi)
library(ggthemes)
library(esquisse)
library(ggthemr)

```

# Unindo tabelas

Dados de estados
```{r}
lista_UF_cobertura = list.files() 

# Lista todos os arquivos CSV no diretório
arquivos_xlsx <- list.files(here(), pattern = "\\.xlsx$", full.names = F)

#Criar funcao
read_xl_sipni <- function(arquivo) {
  dados <- read_excel(arquivo, skip = 4, col_names = FALSE) %>%
    setNames(.[1, ]) %>%
    slice(-1:-4) %>%
    mutate(across(-1, as.numeric)) %>%  
    pivot_longer(cols = -c(1), 
                 names_to = "imuno", 
                 values_to = "cobertura") %>% 
    mutate(arquivo = basename(arquivo)) %>% 
    janitor::clean_names() %>% 
    mutate(cobertura = round(cobertura, 2),
           ano = as.numeric(gsub(".*_(\\d{4})\\.xlsx", "\\1", arquivo)),
           uf = gsub("\\d", "", .[[1]]))  %>% 
    select(-unidade_da_federacao) %>% 
    filter(!is.na(uf),
           !grepl("Gerado", uf)) %>% 
    select(uf, ano, imuno, cobertura) %>% 
    group_by(uf, ano, imuno)
  
  return(dados)
}


# Leia, converta em tabela longa e combine os arquivos CSV em um único DataFrame
sipni_cobertura_uf_1994_2023 <- lapply(arquivos_xlsx, read_xl_sipni) %>%
  bind_rows()

saveRDS(sipni_cobertura_uf_1994_2023, file = "sipni_cobertura_uf_1994_2023.rds")
```


Dados de municípios
```{r}
#Listar tabelas
lista_MU_cobertura = list.files() 
arquivos_xlsx <- list.files(here(), pattern = "\\.xlsx$", full.names = F)

#Criar função
read_xl_sipni_municipio <- function(arquivo) {
  dados <- read_excel(arquivo, skip = 4, col_names = FALSE) %>%
    setNames(.[1, ]) %>%
    slice(-1:-4) %>%
    mutate(across(-1, as.numeric)) %>%  
    pivot_longer(cols = -c(1), 
                 names_to = "imuno", 
                 values_to = "cobertura") %>% 
    mutate(arquivo = basename(arquivo)) %>% 
    janitor::clean_names() %>% 
    mutate(cobertura = round(cobertura, 2),
           ano = as.numeric(gsub(".*_(\\d{4})\\.xlsx", "\\1", arquivo))) %>% 
    filter(!is.na(municipio),
           !grepl("Gerado", municipio)) %>% 
    select(municipio, ano, imuno, cobertura) %>% 
    group_by(municipio, ano, imuno)
  
  return(dados)
}

#Unir dados
sipni_cobertura_municipios_1994_2023 <- lapply(arquivos_xlsx, read_xl_sipni_municipio) %>%
  bind_rows()

#Salvar
saveRDS(sipni_cobertura_municipios_1994_2023, 
          file = "sipni_cobertura_municipios_1994_2023.rds")
```

# Processamento de dados
```{r}
#Estados
sipni_cobertura_uf_1994_2023_2 = sipni_cobertura_uf_1994_2023 %>% 
  mutate(mun_uf = "UF", 
         nome = uf,
         nome =  toupper(nome),
         nome = stri_trans_general(nome, "Latin-ASCII")) %>% 
  select(nome, uf, ano, imuno, cobertura, mun_uf)

saveRDS(sipni_cobertura_uf_1994_2023_2, file = "sipni_cobertura_uf_1994_2023_2.rds")

#Municípios
sipni_cobertura_municipios_1994_2023_2 = sipni_cobertura_municipios_1994_2023 %>% 
 mutate(codigo = as.character(str_extract(municipio, "\\d+")),# Extrair números
        nome = str_remove(municipio, "\\d+ "),# Extrair texto
        mun_uf = "Município" ) %>% 
  select(!"...1":municipio)

glimpse(sipni_cobertura_municipios_1994_2023_2)

# #Unir
# sipni_all = bind_rows(sipni_cobertura_uf_1994_2023_2, sipni_cobertura_municipios_1994_2023_2)
# write.csv(sipni_all, file = "sipni_uf_mun_1994_2023.csv")

```


#Anotar municipios e estados 

```{r}
#Anotações de cidades. Fonte: IBGE. https://www.ibge.gov.br/explica/codigos-dos-municipios.php
dtb_municipios_cod = RELATORIO_DTB_BRASIL_MUNICIPIO %>% 
  clean_names() %>% 
  select(codigo_uf = uf, uf = nome_uf, codigo = codigo_municipio_completo, nome_municipio) %>% 
  mutate(nome_municipio_original = nome_municipio,
         nome =  toupper(nome_municipio_original),
         nome = stri_trans_general(nome, "Latin-ASCII")) %>% 
  select(-nome_municipio)

municipios = sipni_cobertura_municipios_1994_2023_2 %>% 
  mutate(nome = gsub("\\\\", "", nome)) %>% 
  left_join(dtb_municipios_cod, by = "nome") %>% 
  select(nome, nome_municipio_original, uf, codigo_municipio = codigo.y, ano, imuno, cobertura, codigo_uf, mun_uf)

#Salvar
saveRDS(municipios, file = "sipni_cobertura_municipios_1994_2023_2.rds")
  
```


#Análise de dados
Os dados das populações foram obtidos dos anos 2000 a 2022, pois os anos 2007 e 2023 não estavam disponíveis.
Definir variáveis
- https://www.ibge.gov.br/estatisticas/downloads-estatisticas.html 
- Censos
- Perfil Estados
- Perfil Municipios
- Economicos
- Indicadores sociais
- Educacação e qualificação profissional
- Economia de saúde
- Acesso à internet
- Educação
- Saúde

```{r}
install.packages("basedosdados")
library("basedosdados")

# Para carregar o dado direto no R
query <- bdplyr("br_ibge_censo_demografico.microdados_domicilio_1970")
df <- bd_collect(query)


install.packages("bdplyr")
query <- bdplyr("br_ms_atencao_basica.municipio")
df <- bd_collect(query)

```


```{r}
# População ---- 

# Obter população de municipios.
anos = 2000:2023
resultados = list()
for (ano in anos) {
  tryCatch({
    # Chamar a função populacao_municipios para o ano atual e armazenar o resultado na lista
    df_ano <- populacao_municipios(ano)
    df_ano <- df_ano %>%
      mutate_all(as.character)  # Convertendo todas as colunas para character
    resultados[[as.character(ano)]] <- df_ano
  }, error = function(e) {
    # Tratar o erro (por exemplo, imprimir uma mensagem)
    print(paste("Erro para o ano", ano, ":", conditionMessage(e)))
  })
}

# Combinar todos os dataframes em um único dataframe
populacao_municipios_2000_2022 <- bind_rows(resultados, .id = "ano") %>% 
  select(uf_abrev = uf, 
         nome_municipio_original = nome_munic,
         ano, codigo_uf, 
         populacao, 
         codigo_municipio = cod_municipio) %>% 
  mutate(ano = as.numeric(ano),
         populacao = as.numeric(populacao))
  
print(populacao_municipios_2000_2022)


# GDP ----

anos = 1999:2020
pib_municipios(ano = 2003)

resultados = list()
for (ano in anos) {
  tryCatch({
    df_ano <- pib_municipios(ano = ano, dir=".")
    resultados[[ano]] <- df_ano
  }, error = function(e) {
    print(paste("Erro para o ano", ano, ":", conditionMessage(e)))
  })
}

# Combinar todos os dataframes em um único dataframe
populacao_municipios_2000_2022 <- bind_rows(resultados, .id = "ano") %>% 
  select(uf_abrev = uf, 
         nome_municipio_original = nome_munic,
         ano, codigo_uf, 
         populacao, 
         codigo_municipio = cod_municipio) %>% 
  mutate(ano = as.numeric(ano),
         populacao = as.numeric(populacao))
  
print(populacao_municipios_2000_2022)
```


```{r}
#Unir dados

municipios_2 = municipios %>% 
 left_join(populacao_municipios_2000_2022 %>% 
             select(codigo_municipio, ano, populacao),
            by = c("codigo_municipio", "ano"))



```


#IEPS dados


```{r message=FALSE, warning=FALSE}
#Unir dados
IEPS_Brasil_2010_2022_Todos <- read_excel("dados_brutos/IEPS/IEPS_Brasil_2010_2022_Todos.xlsx") %>% 
  mutate(nivel = "Brasil")
IEPS_Estados_2010_2022_Todos <- read_excel("dados_brutos/IEPS/IEPS_Estados_2010_2022_Todos.xlsx") %>% 
  mutate(nivel = "Estado")
IEPS_MacroRegiao_2010_2022_Todos <- read_excel("dados_brutos/IEPS/IEPS_MacroRegiao_2010_2022_Todos.xlsx") %>% 
  mutate(nivel = "Macro Região")
IEPS_Municipios_2010_2022_Todos <- read_excel("dados_brutos/IEPS/IEPS_Municipios_2010_2022_Todos.xlsx") %>% 
  mutate(nivel = "Município")
IEPS_Regiao_2010_2022_Todos <- read_excel("dados_brutos/IEPS/IEPS_Regiao_2010_2022_Todos.xlsx") %>% 
  mutate(nivel = "Região")


IEPS_Completo_2010_2022_Todos = bind_rows(IEPS_Brasil_2010_2022_Todos,
                                          IEPS_Estados_2010_2022_Todos,
                                          IEPS_MacroRegiao_2010_2022_Todos,
                                          IEPS_Regiao_2010_2022_Todos,
                                          IEPS_Municipios_2010_2022_Todos)

IEPS_Completo_2010_2022_Todos %>% 
  saveRDS(file = here("dados_processados", "IEPS_Completo_2010_2022_Todos.rds"))
```

Seleção de variáveis
```{r}
#Converter .csv para .xlsx
IEPS_codebook <- read_delim("dados_brutos/IEPS/IEPS_codebook.csv", 
    delim = ";", escape_double = FALSE, trim_ws = TRUE)
IEPS_codebook %>% 
  write_xlsx(here("dados_brutos", "IEPS",'IEPS_codebook.xlsx'))

#Limpar tabela
IEPS_var_selecionadas = read_excel("dados_processados/IEPS_codebook_selecionados.xlsx") %>% 
  clean_names() %>% 
  filter(selecao == "Sim")

IEPS_var_selecionadas = IEPS_var_selecionadas %>% 
  mutate(bloco = if_else(str_detect(variavel, "cob_vac"), "Cobertura vacinal", bloco))

#Filtrar tabela e converter texto para numérico
IEPS_Completo_2010_2022_Todos <- readRDS(here("dados_processados", "IEPS_Completo_2010_2022_Todos.rds")) %>% 
  mutate(across(c(cob_ab:pct_pop_masc), ~ str_replace(., ",", "."))) %>% 
  mutate(across(c(cob_ab:pct_pop_masc), ~ as.numeric(.))) %>% 
  mutate(ano = lubridate::ymd(ano, truncated = 2L))

IEPS_Completo_2010_2022_Todos %>% saveRDS(here("dados_processados", "IEPS_Completo_2010_2022_Todos.rds"))

IEPS_Completo_2010_2022_selecionados = IEPS_Completo_2010_2022_Todos %>% 
  select(nivel, ano, id_estado:nomemun, IEPS_var_selecionadas$variavel)

IEPS_Completo_2010_2022_selecionados %>% 
  saveRDS(file = here("dados_processados", "IEPS_Completo_2010_2022_selecionados.rds"))

#Dados de São Paulo
IEPS_Completo_2010_2022_selecionados_SP = IEPS_Completo_2010_2022_selecionados %>% 
  filter(estado_abrev == "SP")

IEPS_Completo_2010_2022_selecionados_SP %>% 
  saveRDS(file = here("dados_processados", "IEPS_Completo_2010_2022_selecionados_SP.rds"))


```

#Análise exploratória
```{r fig.height=7, fig.width=12}
#Definir tema
ggthemr("fresh", spacing = 1)
swatch() 
"#111111" "#65ADC2" "#233B43" "#E84646" "#C29365" "#362C21" "#316675" "#168E7F" "#109B37"
```


```{r fig.height=7, fig.width=12}
#Importar dados
IEPS_Completo_2010_2022_selecionados_SP <- readRDS(here("dados_processados", "IEPS_Completo_2010_2022_selecionados_SP.rds"))


IEPS_Completo_filtrado_SP = IEPS_Completo_2010_2022_selecionados_SP %>% 
  filter(nivel == "Estado") %>% 
  pivot_longer(cols = cob_ab:pct_pop_masc,
               names_to = "variavel",
               values_to = "valor") %>% 
  inner_join(IEPS_var_selecionadas, by = "variavel") %>% 
  mutate(ano = lubridate::ymd(ano, truncated = 2L))

vacinas_estado_sp = IEPS_Completo_filtrado_SP %>% 
  filter(bloco == "Cobertura vacinal") %>% 
  mutate(nome_dos_indicadores = str_replace(nome_dos_indicadores, "Cobertura Vacinal de ", "")) %>% 
  ggplot() +
  aes(x = ano, y = valor) +
  scale_x_date(date_breaks = "1 year", date_labels = "%y") +
  scale_y_continuous(expand = expansion(add = 10)) +
  geom_rect(xmin = as.numeric(as.Date("2016-01-01")),
           xmax = as.numeric(as.Date("2020-01-01")),
            ymin = 0,
            ymax = 100,
            fill = "gray",
            alpha = 0.03) +
  geom_rect(xmin = as.numeric(as.Date("2020-01-01")),
               xmax = as.numeric(as.Date("2022-01-01")),
                ymin = 0,
                ymax = 100,
                fill = "gray40",
                alpha = 0.03) +
  geom_line(size = 2, color = "#65ADC2") +
  theme(text = element_text(size = 15)) +
  labs(title = "Cobertura vacinal no estado de São Paulo",
       subtitle = "Período de 2010 a 2022",
       y = "Cobertura vacinal (%)",
       x = "") +
  facet_wrap(~nome_dos_indicadores, scales = "free")

vacinas_estado_sp +
  annotate("text", 
           x = as.Date("2018-01-01"), 
           y = 110, 
           label = "Queda") +
  annotate("text", 
           x = as.Date("2021-01-01"), 
           y = 110, 
           label = "COVID-19")
      
  
```





































